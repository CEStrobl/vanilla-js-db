<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="style.css">
	<title>VAnilla JS DB</title>
</head>
<body>
	<h1>Welcome to Vanilla JS DB Test</h1>
	<p>Testing the Firebase DB's with a live chat</p>

	<div class="container">
		<div class="left">
			<h3>Enter Your Username</h3>
			<input type="text" id="username-input" placeholder="Username">
			<h3>What would you like to say?</h3>
			<input type="text" id="message-input" placeholder="Type your message here...">
			<button id="send-button">Send</button>
		</div>
		<div class="chat-box">
			<div id="messages"></div>
		</div>
	</div>

</body>
<script type="module">
	// Import the functions you need from the SDKs you need
	import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
	// TODO: Add SDKs for Firebase products that you want to use
	// https://firebase.google.com/docs/web/setup#available-libraries

	// Your web app's Firebase configuration
	const firebaseConfig = {
	apiKey: "AIzaSyDyw23yLjCMhdKhqNGxKW-z90XCiUZ4F5Y",
	authDomain: "vanilla-js-d4f2f.firebaseapp.com",
	databaseURL: "https://vanilla-js-d4f2f-default-rtdb.firebaseio.com",
	projectId: "vanilla-js-d4f2f",
	storageBucket: "vanilla-js-d4f2f.firebasestorage.app",
	messagingSenderId: "789411057023",
	appId: "1:789411057023:web:0d345726a346e1391ade4a"
	};

	// Initialize Firebase
	const app = initializeApp(firebaseConfig);

	import { getDatabase, set, get, update, remove, ref, child } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

	const db = getDatabase();

	var messages = document.getElementById("messages");
	var username = document.getElementById("username-input");
	var messageInput = document.getElementById("message-input");

	var sendButton = document.getElementById("send-button");


	function sendMessage() {
		var user = username.value.trim();
		var message = messageInput.value.trim();
		if (user && message) {
			var newMessageRef = ref(db, 'messages/' + Date.now());
			set(newMessageRef, {
				username: user,
				date: new Date().toLocaleString(),
				time: Date.now(),
				message: message
			}).then(() => {
				messageInput.value = '';
			});
		}
	}

	function updateChat() {
		const dbRef = ref(db);
		get(child(dbRef, 'messages')).then((snapshot) => {
			if (snapshot.exists()) {
				messages.innerHTML = '';
				const data = snapshot.val();
				const sortedKeys = Object.keys(data).sort((a, b) => data[a].time - data[b].time);
				sortedKeys.forEach(key => {
					const msg = data[key];
					const messageElement = document.createElement('div');
					messageElement.classList.add('message');
					messageElement.innerHTML = `<strong>${msg.username}</strong> <em>${msg.date}</em><br>${msg.message}`;
					messages.appendChild(messageElement);
				});
			}
		});
	}

	// event listeners
	sendButton.addEventListener('click', sendMessage);
	updateChat()
	setInterval(updateChat, 1000);

</script>
</html>